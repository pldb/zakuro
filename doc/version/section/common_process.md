# 共通の求め方

全暦で共通に行う求め方を記載する

これから記すことは原則として実装の問題であり、計算手順そのものは特定の資料に依拠するものではない

『日本暦日原典』と同等の計算結果を出すためには、暦法編（同p.491〜）だけでは不十分である

本ライブラリの目的の一つは、与えられた西暦日/和暦日から、対象の和暦日（和暦計算結果）を取りだすことにある

この西暦日から和暦日を引き当てるための手順を記載する

# 暦の特定

西暦年月日から対象の暦を特定する

『日本暦日原典』を参考に、次の対応関係を抽出した

|開始日|暦   |
|:----|:----|
|445/01/24|元嘉暦|
|698/02/16|儀鳳暦|
|764/02/07|大衍暦|
|862/02/03|宣明暦|
|1685/02/04|貞享暦|
|1755/02/11|宝暦暦|
|1798/02/16|寛政暦|
|1844/02/18|天保暦|
|1872/12/09|グレゴリオ暦|

一例として、450年01月01日であれば、 `元嘉暦` の範囲内であることが分かる

# 元号の特定

西暦年月日から対象の元号を特定する

西暦日と元号の対応関係については、 [元号](../../gengou.md) に記載してある

一例として、878年01月01日であれば、 *元慶* （ 877/06/01 ～ 885/03/10 ）の範囲内であることが分かる

# 計算範囲の特定



TODO: 次の内容を上で清書すること

### 計算の流れ

正慶1年の日数を出すための流れを図示する

![各月の求め方](../../../images/各月の求め方.png)

最後の「355日」を出すためには、月ごとの日数を出す必要がある

月ごとの日数は定朔によって得られるが、それは経朔を補正することで得られる

この図の正慶1年は宣明暦に属するため、定朔まで求める必要がある

11月定朔に必要な「経朔」「入定気（二十四節気）」「月の進退」は冬至計算で求められる

従って、まずは各年の冬至を求めなければならない

計算の多くはそれぞれの暦に依存するが、まずは共通の計算部分を列挙する

### 元号の求め方

元慶（877-6-1 ～ 885-3-10）をもとに考える

元号開始年が存在する元号年（877）から、次の元号の開始年（885） + 1 までを和暦計算する。これをAとする

元号のはじまりは固定値のため、西暦開始日と、それに対応する和暦開始日を持つ（例: 元慶01年04月16日 = 877-6-1）

この和暦開始日は必ずAの1年目に存在するため、1年目の和暦日を特定し、その日と西暦開始日を関連付ける

もし元慶2年以降を計算したい場合は、Aの西暦開始日から該当年月日までを加算で求める

具体的には、和暦上の月の大小（29日 or 30日）を用いた加算となる

念のため補足するが、西暦（太陽暦）のように1年あたりの日数は一定しない

平年（353/354/355/356）または閏年(383/384/385）のパターンがあり、月の大小（29/30）や閏月（中気のない月）の有無で変動する

したがって、2年目以降を加算なしに特定することはできない

### 南北朝について

南北朝による元号の並立がある（正慶１年 / 元弘2年）

このような場合、元号は早くから始まったほうを基準に計算しなければならない（正慶 よりは 元弘 の方が一年早い）

並立は最大でも2つであり、並びは『日本暦日原典』に従う
